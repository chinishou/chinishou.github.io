<?xml version="1.0" encoding="utf-8"?><?xml-stylesheet type="text/xsl" href="rss.xsl"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Wei - TD/TA Blog</title>
        <link>https://chinishou.github.io/blog</link>
        <description>Wei - TD/TA Blog</description>
        <lastBuildDate>Sun, 16 Nov 2025 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[專案追蹤資料快取系統： 多讀單寫的資料架構設計紀錄]]></title>
            <link>https://chinishou.github.io/blog/SG-FPT-cache-system-design-note</link>
            <guid>https://chinishou.github.io/blog/SG-FPT-cache-system-design-note</guid>
            <pubDate>Sun, 16 Nov 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[1. 問題背景]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-問題背景">1. 問題背景<a href="https://chinishou.github.io/blog/SG-FPT-cache-system-design-note#1-%E5%95%8F%E9%A1%8C%E8%83%8C%E6%99%AF" class="hash-link" aria-label="Direct link to 1. 問題背景" title="Direct link to 1. 問題背景" translate="no">​</a></h2>
<ul>
<li class="">產業：CG, VFX</li>
<li class=""><strong>目的是減少訪問SG/FPT的次數，重複使用資料，而非追求速度</strong></li>
<li class="">column通常不超過50</li>
<li class="">寫入頻率：200 人 × 每天約 100 筆 → <strong>20,000 writes / day</strong></li>
<li class="">讀取則預估約寫入的 10 倍 → <strong>200,000 reads / day</strong></li>
<li class="">使用情境：<!-- -->
<ul>
<li class="">專案結束後可丟棄或單獨備份</li>
<li class=""><strong>寫少讀多</strong></li>
<li class="">想要<strong>最低</strong>維護成本（人力、硬體、知識負擔）</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-目標">2. 目標<a href="https://chinishou.github.io/blog/SG-FPT-cache-system-design-note#2-%E7%9B%AE%E6%A8%99" class="hash-link" aria-label="Direct link to 2. 目標" title="Direct link to 2. 目標" translate="no">​</a></h2>
<ul>
<li class="">Python生態系</li>
<li class="">能Relational searching</li>
<li class="">不host DB</li>
<li class="">可依日期 / 專案歸檔</li>
<li class="">單writer與多reader並行</li>
<li class="">崩潰後能快速復原，復原後自動重試任務隊列</li>
<li class="">在NFS上存放快照，出錯時直接讀取快照應急</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-tech-stack選擇">3. Tech stack選擇<a href="https://chinishou.github.io/blog/SG-FPT-cache-system-design-note#3-tech-stack%E9%81%B8%E6%93%87" class="hash-link" aria-label="Direct link to 3. Tech stack選擇" title="Direct link to 3. Tech stack選擇" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="writer">Writer<a href="https://chinishou.github.io/blog/SG-FPT-cache-system-design-note#writer" class="hash-link" aria-label="Direct link to Writer" title="Direct link to Writer" translate="no">​</a></h3>
<table><thead><tr><th>技術</th><th>優點</th><th>缺點</th></tr></thead><tbody><tr><td><strong>FastAPI</strong></td><td>async、auto-doc、pydantic validation、生態成熟</td><td>稍重（uvicorn + deps）</td></tr><tr><td><strong>Litestar</strong></td><td>async、auto-doc、plugin system、type hints</td><td>生態較新</td></tr><tr><td><strong>http.server + custom handler</strong></td><td>自由度高</td><td>開發運維成本也高</td></tr><tr><td><strong>Deadline worker</strong></td><td>現成、開發運維成本近乎於零</td><td>不夠可靠</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="database">Database<a href="https://chinishou.github.io/blog/SG-FPT-cache-system-design-note#database" class="hash-link" aria-label="Direct link to Database" title="Direct link to Database" translate="no">​</a></h3>
<table><thead><tr><th>技術</th><th>優點</th><th>缺點</th><th>適合用途</th></tr></thead><tbody><tr><td><strong>SQLite</strong></td><td>單寫多讀、成熟、簡單</td><td>寫入阻塞（但量不大可接受）</td><td>日檔 or 小型 transactional</td></tr><tr><td><strong>DuckDB + Parquet</strong></td><td>超快查詢、免載整檔</td><td>不適合多 writer</td><td>分析查詢、多 reader</td></tr><tr><td><strong>LMDB</strong></td><td>超快讀、多 reader、單 writer</td><td>嚴格單 writer，寫入可能 block</td><td>queue、metadata</td></tr><tr><td><strong>Redis (AOF)</strong></td><td>又快又簡單又好維護</td><td>不能SQL</td><td>純key-value，不需要關聯性搜索</td></tr><tr><td><strong>PostgresSQL</strong></td><td>功能完整強大</td><td>維運成本</td><td>更複雜的情境</td></tr></tbody></table>
<p>Writer API候選方案:</p>
<ul>
<li class=""><strong>FastAPI</strong></li>
<li class=""><strong>Deadline worker</strong></li>
</ul>
<p>資料庫候選方案：</p>
<ul>
<li class=""><strong>DuckDB</strong></li>
<li class=""><strong>Parquet</strong></li>
<li class=""><strong>SQLite</strong></li>
</ul>
<p>任務隊列候選方案:</p>
<ul>
<li class=""><strong>SQLite</strong></li>
<li class=""><strong>LMDB</strong></li>
<li class=""><strong>Deadline內建</strong></li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-架構總覽">4. 架構總覽<a href="https://chinishou.github.io/blog/SG-FPT-cache-system-design-note#4-%E6%9E%B6%E6%A7%8B%E7%B8%BD%E8%A6%BD" class="hash-link" aria-label="Direct link to 4. 架構總覽" title="Direct link to 4. 架構總覽" translate="no">​</a></h2>
<ul>
<li class="">Writer 採「事件 append-only」寫入（如 WAL/queue）</li>
<li class="">後端負責合併資料與產生日檔/parquet/db</li>
<li class="">Reader 讀的是 <strong>已封存的穩定檔案</strong>（immutable file）</li>
<li class="">Writer 當掉時可重跑 queue，或讀 snapshot 繼續寫</li>
</ul>
<!-- -->
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="5-檔案分割策略">5. 檔案分割策略<a href="https://chinishou.github.io/blog/SG-FPT-cache-system-design-note#5-%E6%AA%94%E6%A1%88%E5%88%86%E5%89%B2%E7%AD%96%E7%95%A5" class="hash-link" aria-label="Direct link to 5. 檔案分割策略" title="Direct link to 5. 檔案分割策略" translate="no">​</a></h2>
<p>✔ 可做 <strong>按日期</strong> 或 <strong>按專案</strong> 分檔<br>
<!-- -->✔ Writer 只寫「當天」或「當前專案」<br>
<!-- -->✔ Reader 可讀所有檔案（通常是只讀且並行度高）</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="6-背景-queue--wal-設計">6. 背景 Queue / WAL 設計<a href="https://chinishou.github.io/blog/SG-FPT-cache-system-design-note#6-%E8%83%8C%E6%99%AF-queue--wal-%E8%A8%AD%E8%A8%88" class="hash-link" aria-label="Direct link to 6. 背景 Queue / WAL 設計" title="Direct link to 6. 背景 Queue / WAL 設計" translate="no">​</a></h2>
<p>Writer 收到資料後：</p>
<ol>
<li class="">append event → queue（例如 SQLite / LMDB）</li>
<li class="">回應 client（不必等資料合併）</li>
<li class="">背景 worker 定期將 queue 事件 <strong>merge 成 Parquet</strong></li>
<li class="">清除已處理事件</li>
</ol>
<p>等同 event sourcing + compaction：</p>
<blockquote>
<p>單寫、多讀、高穩定性的 event-based architecture</p>
</blockquote>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="7-崩潰復原策略">7. 崩潰復原策略<a href="https://chinishou.github.io/blog/SG-FPT-cache-system-design-note#7-%E5%B4%A9%E6%BD%B0%E5%BE%A9%E5%8E%9F%E7%AD%96%E7%95%A5" class="hash-link" aria-label="Direct link to 7. 崩潰復原策略" title="Direct link to 7. 崩潰復原策略" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="writer-崩潰">Writer 崩潰<a href="https://chinishou.github.io/blog/SG-FPT-cache-system-design-note#writer-%E5%B4%A9%E6%BD%B0" class="hash-link" aria-label="Direct link to Writer 崩潰" title="Direct link to Writer 崩潰" translate="no">​</a></h3>
<ul>
<li class="">queue（SQLite/LMDB）是 ACID</li>
<li class="">重啟之後 worker 讀 queue 裡尚未 processed 的事件重新跑</li>
<li class="">不會遺失資料</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="worker-崩潰">Worker 崩潰<a href="https://chinishou.github.io/blog/SG-FPT-cache-system-design-note#worker-%E5%B4%A9%E6%BD%B0" class="hash-link" aria-label="Direct link to Worker 崩潰" title="Direct link to Worker 崩潰" translate="no">​</a></h3>
<ul>
<li class="">不影響 writer</li>
<li class="">compaction 沒跑完下次重啟再跑</li>
<li class="">snapshot（Parquet/SQLite）仍有效</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="snapshot--nfs-備援">Snapshot / NFS 備援<a href="https://chinishou.github.io/blog/SG-FPT-cache-system-design-note#snapshot--nfs-%E5%82%99%E6%8F%B4" class="hash-link" aria-label="Direct link to Snapshot / NFS 備援" title="Direct link to Snapshot / NFS 備援" translate="no">​</a></h3>
<ul>
<li class="">定時 copy parquet 到 NFS</li>
<li class="">API 掛掉 → 客戶端 switch 到 <strong>直接讀 NFS</strong></li>
<li class="">parquet 支持 predicate pushdown → 不需讀整檔</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="8-範例代碼">8. 範例代碼<a href="https://chinishou.github.io/blog/SG-FPT-cache-system-design-note#8-%E7%AF%84%E4%BE%8B%E4%BB%A3%E7%A2%BC" class="hash-link" aria-label="Direct link to 8. 範例代碼" title="Direct link to 8. 範例代碼" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="快取服務出問題時客戶端直接讀檔">快取服務出問題時，客戶端直接讀檔<a href="https://chinishou.github.io/blog/SG-FPT-cache-system-design-note#%E5%BF%AB%E5%8F%96%E6%9C%8D%E5%8B%99%E5%87%BA%E5%95%8F%E9%A1%8C%E6%99%82%E5%AE%A2%E6%88%B6%E7%AB%AF%E7%9B%B4%E6%8E%A5%E8%AE%80%E6%AA%94" class="hash-link" aria-label="Direct link to 快取服務出問題時，客戶端直接讀檔" title="Direct link to 快取服務出問題時，客戶端直接讀檔" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="duckdb-client-read-示例">DuckDB client read 示例<a href="https://chinishou.github.io/blog/SG-FPT-cache-system-design-note#duckdb-client-read-%E7%A4%BA%E4%BE%8B" class="hash-link" aria-label="Direct link to DuckDB client read 示例" title="Direct link to DuckDB client read 示例" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> duckdb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">con </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> duckdb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">df </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> con</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token triple-quoted-string string" style="color:#e3116c">"""</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    SELECT * </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    FROM 'nfs/projects/*.parquet'</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    WHERE project_id = 123</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">"""</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="sqlite-queue-schema">SQLite queue schema<a href="https://chinishou.github.io/blog/SG-FPT-cache-system-design-note#sqlite-queue-schema" class="hash-link" aria-label="Direct link to SQLite queue schema" title="Direct link to SQLite queue schema" translate="no">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> queue </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id </span><span class="token keyword" style="color:#00009f">INTEGER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> AUTOINCREMENT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    event JSON</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ts </span><span class="token keyword" style="color:#00009f">TIMESTAMP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">CURRENT_TIMESTAMP</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    processed </span><span class="token keyword" style="color:#00009f">INTEGER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="fastapi-append-event">FastAPI append event<a href="https://chinishou.github.io/blog/SG-FPT-cache-system-design-note#fastapi-append-event" class="hash-link" aria-label="Direct link to FastAPI append event" title="Direct link to FastAPI append event" translate="no">​</a></h3>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> fastapi </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> FastAPI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> sqlite3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> FastAPI</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">conn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sqlite3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"queue.db"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> check_same_thread</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@app</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">post</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/write"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">write_event</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">dict</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"INSERT INTO queue (event) VALUES (?)"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dumps</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">commit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"status"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ok"</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="背景-worker合併到-parquet">背景 Worker（合併到 Parquet）<a href="https://chinishou.github.io/blog/SG-FPT-cache-system-design-note#%E8%83%8C%E6%99%AF-worker%E5%90%88%E4%BD%B5%E5%88%B0-parquet" class="hash-link" aria-label="Direct link to 背景 Worker（合併到 Parquet）" title="Direct link to 背景 Worker（合併到 Parquet）" translate="no">​</a></h3>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> sqlite3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> duckdb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pyarrow </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> pyarrow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">parquet </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> pq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">process_queue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sqlite3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"queue.db"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cur </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"SELECT id, event FROM queue WHERE processed = 0"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rows </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"id"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> r</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">**</span><span class="token plain">json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loads</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> r </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> cur</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fetchall</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> rows</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 轉成 Parquet</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    table </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Table</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_pylist</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rows</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write_table</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"data/day_2025_02_17.parquet"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> append</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ids </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"id"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> r </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> rows</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string-interpolation string" style="color:#e3116c">f"UPDATE queue SET processed=1 WHERE id IN (</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation string" style="color:#e3116c">','</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">join</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation builtin">map</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation builtin">str</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">,</span><span class="token string-interpolation interpolation"> ids</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">)"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">commit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="lmdb-作為-queue-的範例">LMDB 作為 Queue 的範例<a href="https://chinishou.github.io/blog/SG-FPT-cache-system-design-note#lmdb-%E4%BD%9C%E7%82%BA-queue-%E7%9A%84%E7%AF%84%E4%BE%8B" class="hash-link" aria-label="Direct link to LMDB 作為 Queue 的範例" title="Direct link to LMDB 作為 Queue 的範例" translate="no">​</a></h3>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> lmdb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> json</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">env </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lmdb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"queue.lmdb"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> map_size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1e9</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">enqueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">begin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">write</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> txn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">time_ns</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        txn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dumps</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="9-最終選擇">9. 最終選擇<a href="https://chinishou.github.io/blog/SG-FPT-cache-system-design-note#9-%E6%9C%80%E7%B5%82%E9%81%B8%E6%93%87" class="hash-link" aria-label="Direct link to 9. 最終選擇" title="Direct link to 9. 最終選擇" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="最低維運最高可靠讀寫模式最適配">最低維運、最高可靠、讀寫模式最適配：<a href="https://chinishou.github.io/blog/SG-FPT-cache-system-design-note#%E6%9C%80%E4%BD%8E%E7%B6%AD%E9%81%8B%E6%9C%80%E9%AB%98%E5%8F%AF%E9%9D%A0%E8%AE%80%E5%AF%AB%E6%A8%A1%E5%BC%8F%E6%9C%80%E9%81%A9%E9%85%8D" class="hash-link" aria-label="Direct link to 最低維運、最高可靠、讀寫模式最適配：" title="Direct link to 最低維運、最高可靠、讀寫模式最適配：" translate="no">​</a></h3>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="writer-1">Writer<a href="https://chinishou.github.io/blog/SG-FPT-cache-system-design-note#writer-1" class="hash-link" aria-label="Direct link to Writer" title="Direct link to Writer" translate="no">​</a></h3>
<ul>
<li class="">FastAPI</li>
<li class="">單一 writer process → 追加事件到 Queue</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="queue">Queue<a href="https://chinishou.github.io/blog/SG-FPT-cache-system-design-note#queue" class="hash-link" aria-label="Direct link to Queue" title="Direct link to Queue" translate="no">​</a></h3>
<ul>
<li class="">SQLite</li>
<li class="">追求效能再用 LMDB</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="background-worker">Background Worker<a href="https://chinishou.github.io/blog/SG-FPT-cache-system-design-note#background-worker" class="hash-link" aria-label="Direct link to Background Worker" title="Direct link to Background Worker" translate="no">​</a></h3>
<ul>
<li class="">定期將 queue → Parquet</li>
<li class="">分日期/專案產檔</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="reader">Reader<a href="https://chinishou.github.io/blog/SG-FPT-cache-system-design-note#reader" class="hash-link" aria-label="Direct link to Reader" title="Direct link to Reader" translate="no">​</a></h3>
<ul>
<li class="">客戶端可以直接讀 parquet + DuckDB</li>
<li class="">或經 API 查詢</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="failover">Failover<a href="https://chinishou.github.io/blog/SG-FPT-cache-system-design-note#failover" class="hash-link" aria-label="Direct link to Failover" title="Direct link to Failover" translate="no">​</a></h3>
<ul>
<li class="">queue ACID 保證不遺失</li>
<li class="">parquet snapshot 放 NFS</li>
<li class="">API 掛掉讀 snapshot 仍可運作</li>
</ul>
<hr>]]></content:encoded>
            <category>Python</category>
            <category>Shotgun/Shotgrid/FlowProductionTracking</category>
            <category>Database</category>
        </item>
        <item>
            <title><![CDATA[Welcome]]></title>
            <link>https://chinishou.github.io/blog/welcome</link>
            <guid>https://chinishou.github.io/blog/welcome</guid>
            <pubDate>Thu, 26 Aug 2021 00:00:00 GMT</pubDate>
            <description><![CDATA[The blog post date can be extracted from filenames, such as:]]></description>
            <content:encoded><![CDATA[<p>The blog post date can be extracted from filenames, such as:</p>
<ul>
<li class=""><code>2019-05-30-welcome.md</code></li>
<li class=""><code>2019-05-30-welcome/index.md</code></li>
</ul>
<p>A blog post folder can be convenient to co-locate blog post images:</p>
<p><img decoding="async" loading="lazy" alt="Docusaurus Plushie" src="https://chinishou.github.io/assets/images/docusaurus-plushie-banner-a60f7593abca1e3eef26a9afa244e4fb.jpeg" width="1500" height="500" class="img_ev3q"></p>
<p><strong>And if you don't want a blog</strong>: just delete this directory, and use <code>blog: false</code> in your Docusaurus config.</p>]]></content:encoded>
        </item>
    </channel>
</rss>