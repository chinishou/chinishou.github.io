<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">One post tagged with &quot;Python&quot; | Wei - TD/TA</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://chinishou.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://chinishou.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://chinishou.github.io/blog/tags/python"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="One post tagged with &quot;Python&quot; | Wei - TD/TA"><meta data-rh="true" name="description" content="Python programming language"><meta data-rh="true" property="og:description" content="Python programming language"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://chinishou.github.io/blog/tags/python"><link data-rh="true" rel="alternate" href="https://chinishou.github.io/blog/tags/python" hreflang="en"><link data-rh="true" rel="alternate" href="https://chinishou.github.io/blog/tags/python" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Wei - TD/TA RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Wei - TD/TA Atom Feed"><link rel="stylesheet" href="/assets/css/styles.9072f9ea.css">
<script src="/assets/js/runtime~main.10b1ef16.js" defer="defer"></script>
<script src="/assets/js/main.4c973b77.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.png"><link rel="preload" as="image" href="https://www.linkedin.com/in/weihsiangchen-fx"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Wei - TD/TA</b></a><a class="navbar__item navbar__link" href="/docs/intro">Tutorial</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/SG-FPT-cache-system-design-note">å°ˆæ¡ˆè¿½è¹¤è³‡æ–™å¿«å–ç³»çµ±ï¼šå–®ä¸€ Writerã€å¤š Reader çš„è³‡æ–™æ¶æ§‹è¨­è¨ˆç´€éŒ„</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2021</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/welcome">Welcome</a></li></ul></div></nav></aside><main class="col col--7"><header class="margin-bottom--xl"><h1>One post tagged with &quot;Python&quot;</h1><p>Python programming language</p><a href="/blog/tags">View All Tags</a></header><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/SG-FPT-cache-system-design-note">å°ˆæ¡ˆè¿½è¹¤è³‡æ–™å¿«å–ç³»çµ±ï¼šå–®ä¸€ Writerã€å¤š Reader çš„è³‡æ–™æ¶æ§‹è¨­è¨ˆç´€éŒ„</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-11-16T00:00:00.000Z">November 16, 2025</time> Â· <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/blog/authors/weihsiangchen"><img class="avatar__photo authorImage_XqGP" src="https://www.linkedin.com/in/weihsiangchen-fx" alt="Wei Hsiang Chen"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/blog/authors/weihsiangchen"><span class="authorName_yefp" translate="no">Wei Hsiang Chen</span></a></div><small class="authorTitle_nd0D" title="Pipeline TD">Pipeline TD</small><div class="authorSocials_rSDt"><a href="https://x.com/wei_Ch_" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="X"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="none" viewBox="0 0 1200 1227" style="--dark:#000;--light:#fff" class="authorSocialIcon_XYv3 xSvg_y3PF"><path d="M714.163 519.284 1160.89 0h-105.86L667.137 450.887 357.328 0H0l468.492 681.821L0 1226.37h105.866l409.625-476.152 327.181 476.152H1200L714.137 519.284h.026ZM569.165 687.828l-47.468-67.894-377.686-540.24h162.604l304.797 435.991 47.468 67.894 396.2 566.721H892.476L569.165 687.854v-.026Z"></path></svg></a><a href="https://www.linkedin.com/in/weihsiangchen-fx/" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 256" style="--dark:#0a66c2;--light:#ffffffe6" class="authorSocialIcon_XYv3 linkedinSvg_FCgI"><path d="M218.123 218.127h-37.931v-59.403c0-14.165-.253-32.4-19.728-32.4-19.756 0-22.779 15.434-22.779 31.369v60.43h-37.93V95.967h36.413v16.694h.51a39.907 39.907 0 0 1 35.928-19.733c38.445 0 45.533 25.288 45.533 58.186l-.016 67.013ZM56.955 79.27c-12.157.002-22.014-9.852-22.016-22.009-.002-12.157 9.851-22.014 22.008-22.016 12.157-.003 22.014 9.851 22.016 22.008A22.013 22.013 0 0 1 56.955 79.27m18.966 138.858H37.95V95.967h37.97v122.16ZM237.033.018H18.89C8.58-.098.125 8.161-.001 18.471v219.053c.122 10.315 8.576 18.582 18.89 18.474h218.144c10.336.128 18.823-8.139 18.966-18.474V18.454c-.147-10.33-8.635-18.588-18.966-18.453"></path></svg></a><a href="https://github.com/chinishou" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialIcon_XYv3 githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a><a href="https://chinishou.github.io/" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="newsletter"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="authorSocialIcon_XYv3"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M1.2 12a10.8 10.8 0 1 0 21.6 0a10.8 10.8 0 0 0 -21.6 0"></path><path d="M1.92 8.4h20.16"></path><path d="M1.92 15.6h20.16"></path><path d="M11.4 1.2a20.4 20.4 0 0 0 0 21.6"></path><path d="M12.6 1.2a20.4 20.4 0 0 1 0 21.6"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p>ï¼ˆPythonã€FastAPI å…§ç¶²ç’°å¢ƒã€SQLite / DuckDB / Parquetï¼‰</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-å•é¡ŒèƒŒæ™¯">1. å•é¡ŒèƒŒæ™¯<a href="#1-å•é¡ŒèƒŒæ™¯" class="hash-link" aria-label="Direct link to 1. å•é¡ŒèƒŒæ™¯" title="Direct link to 1. å•é¡ŒèƒŒæ™¯" translate="no">â€‹</a></h2>
<ul>
<li class="">ç”¢æ¥­ï¼šå½±è¦–</li>
<li class="">ç›®çš„æ˜¯æ¸›å°‘è¨ªå•SG/FPTçš„æ¬¡æ•¸ï¼Œè€Œéè¿½æ±‚é€Ÿåº¦</li>
<li class="">columné€šå¸¸ä¸è¶…é50</li>
<li class="">å¯«å…¥é »ç‡ï¼š200 äºº Ã— æ¯å¤©ç´„ 100 ç­† â†’ <strong>20,000 writes / day</strong></li>
<li class="">è®€å–å‰‡é ä¼°ç´„å¯«å…¥çš„ 10 å€ â†’ <strong>200,000 reads / day</strong></li>
<li class="">ä½¿ç”¨æƒ…å¢ƒï¼š<!-- -->
<ul>
<li class="">å°ˆæ¡ˆçµæŸå¾Œå¯ä¸Ÿæ£„æˆ–å–®ç¨å‚™ä»½</li>
<li class=""><strong>å¯«å°‘è®€å¤š</strong></li>
<li class="">æƒ³è¦æœ€ä½ç¶­è­·æˆæœ¬ï¼ˆäººåŠ›ã€ç¡¬é«”ã€çŸ¥è­˜è² æ“”ï¼‰</li>
</ul>
</li>
</ul>
<p>ç›®æ¨™ï¼š</p>
<ul>
<li class="">èƒ½Relational searching</li>
<li class="">Embedded DB</li>
<li class="">å¯ä¾æ—¥æœŸ / å°ˆæ¡ˆæ­¸æª”</li>
<li class="">å–®ä¸€writerèˆ‡å¤šreaderä¸¦è¡Œ</li>
<li class="">å´©æ½°å¾Œèƒ½å¿«é€Ÿå¾©åŸï¼Œå¾©åŸå¾Œè‡ªå‹•é‡è©¦ä»»å‹™éšŠåˆ—</li>
<li class="">åœ¨NFSä¸Šå­˜æ”¾å¿«ç…§ï¼Œç³»çµ±å´©æ½°æ™‚è®€å–å…¶ä½œç‚ºæ‡‰æ€¥æ–¹æ¡ˆ</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-æ¶æ§‹ç¸½è¦½">2. æ¶æ§‹ç¸½è¦½<a href="#2-æ¶æ§‹ç¸½è¦½" class="hash-link" aria-label="Direct link to 2. æ¶æ§‹ç¸½è¦½" title="Direct link to 2. æ¶æ§‹ç¸½è¦½" translate="no">â€‹</a></h2>
<ul>
<li class="">Writer æ¡ã€Œäº‹ä»¶ append-onlyã€å¯«å…¥ï¼ˆå¦‚ WAL/queueï¼‰</li>
<li class="">å¾Œç«¯è² è²¬åˆä½µè³‡æ–™èˆ‡ç”¢ç”Ÿæ—¥æª”/parquet/db</li>
<li class="">Reader è®€çš„æ˜¯ <strong>å·²å°å­˜çš„ç©©å®šæª”æ¡ˆ</strong>ï¼ˆimmutable fileï¼‰</li>
<li class="">Writer ç•¶æ‰æ™‚å¯é‡è·‘ queueï¼Œæˆ–è®€ snapshot ç¹¼çºŒå¯«</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="ï¸-mermaid-æ¶æ§‹åœ–">ğŸ—ï¸ Mermaid æ¶æ§‹åœ–<a href="#ï¸-mermaid-æ¶æ§‹åœ–" class="hash-link" aria-label="Direct link to ğŸ—ï¸ Mermaid æ¶æ§‹åœ–" title="Direct link to ğŸ—ï¸ Mermaid æ¶æ§‹åœ–" translate="no">â€‹</a></h2>
<div class="language-mermaid codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-mermaid codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">flowchart LR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subgraph Clients</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    A[ä½¿ç”¨è€… / å®¢æˆ¶ç«¯]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">A --&gt;|Write| W[&quot;Writer&lt;br&gt;(FastAPI)&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">W --&gt;|Append event| Q[&quot;Queue DB&lt;br&gt;(SQLite/LMDB)&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">W --&gt;|Read| S[&quot;(Snapshots&lt;br&gt;Parquet/SQLite)&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subgraph Background Workers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M[Merger / Compaction Worker]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Q --&gt;|Batch Process| M</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">M --&gt;|Write Partition Files| S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">A --&gt;|Direct Read| S</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-æª”æ¡ˆåˆ†å‰²ç­–ç•¥">3. æª”æ¡ˆåˆ†å‰²ç­–ç•¥<a href="#3-æª”æ¡ˆåˆ†å‰²ç­–ç•¥" class="hash-link" aria-label="Direct link to 3. æª”æ¡ˆåˆ†å‰²ç­–ç•¥" title="Direct link to 3. æª”æ¡ˆåˆ†å‰²ç­–ç•¥" translate="no">â€‹</a></h2>
<p>âœ” å¯åš <strong>æŒ‰æ—¥æœŸ</strong> æˆ– <strong>æŒ‰å°ˆæ¡ˆ</strong> åˆ†æª”<br>
<!-- -->âœ” Writer åªå¯«ã€Œç•¶å¤©ã€æˆ–ã€Œç•¶å‰å°ˆæ¡ˆã€<br>
<!-- -->âœ” Reader å¯è®€æ‰€æœ‰æª”æ¡ˆï¼ˆé€šå¸¸æ˜¯åªè®€ä¸”ä¸¦è¡Œåº¦é«˜ï¼‰</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-å¤šè®€å–®å¯«ç­–ç•¥å¯èƒ½çš„è³‡æ–™æ ¼å¼">4. å¤šè®€å–®å¯«ç­–ç•¥ï¼šå¯èƒ½çš„è³‡æ–™æ ¼å¼<a href="#4-å¤šè®€å–®å¯«ç­–ç•¥å¯èƒ½çš„è³‡æ–™æ ¼å¼" class="hash-link" aria-label="Direct link to 4. å¤šè®€å–®å¯«ç­–ç•¥ï¼šå¯èƒ½çš„è³‡æ–™æ ¼å¼" title="Direct link to 4. å¤šè®€å–®å¯«ç­–ç•¥ï¼šå¯èƒ½çš„è³‡æ–™æ ¼å¼" translate="no">â€‹</a></h2>
<table><thead><tr><th>æŠ€è¡“</th><th>å„ªé»</th><th>ç¼ºé»</th><th>é©åˆç”¨é€”</th></tr></thead><tbody><tr><td><strong>SQLite</strong></td><td>å–®å¯«å¤šè®€ã€æˆç†Ÿã€ç°¡å–®</td><td>å¯«å…¥é˜»å¡ï¼ˆä½†é‡ä¸å¤§å¯æ¥å—ï¼‰</td><td>æ—¥æª” or å°å‹ transactional</td></tr><tr><td><strong>DuckDB + Parquet</strong></td><td>è¶…å¿«æŸ¥è©¢ã€å…è¼‰æ•´æª”</td><td>ä¸é©åˆå¤š writerï¼ˆä½†ä½ ç”¨å–® writer å³å¯ï¼‰</td><td>åˆ†ææŸ¥è©¢ã€å¤š reader</td></tr><tr><td><strong>LMDB</strong></td><td>è¶…å¿«è®€ã€å¤š readerã€å–® writer</td><td>åš´æ ¼å–® writerï¼Œå¯«å…¥å¯èƒ½ block</td><td>queueã€metadata</td></tr><tr><td><strong>Redis (AOF)</strong></td><td>åš queue æµç¨‹å¾ˆå¼·</td><td>å¤šä¸€é“ç¶­é‹</td><td>è‹¥è¦æ›´å½ˆæ€§ event queue</td></tr></tbody></table>
<p>å€™é¸æ–¹æ¡ˆï¼š</p>
<ul>
<li class=""><strong>Parquet + DuckDB</strong></li>
<li class=""><strong>SQLite</strong></li>
</ul>
<p>è½é¸æ–¹æ¡ˆ:</p>
<ul>
<li class="">Redis: ç„¡æ³•SQL</li>
<li class="">Postgres: ä¸å¿…è¦çš„ç¶­è­·æˆæœ¬</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="5-èƒŒæ™¯-queue--wal-è¨­è¨ˆ">5. èƒŒæ™¯ Queue / WAL è¨­è¨ˆ<a href="#5-èƒŒæ™¯-queue--wal-è¨­è¨ˆ" class="hash-link" aria-label="Direct link to 5. èƒŒæ™¯ Queue / WAL è¨­è¨ˆ" title="Direct link to 5. èƒŒæ™¯ Queue / WAL è¨­è¨ˆ" translate="no">â€‹</a></h2>
<p>Writer æ”¶åˆ°è³‡æ–™å¾Œï¼š</p>
<ol>
<li class="">append event â†’ queueï¼ˆä¾‹å¦‚ SQLite / LMDBï¼‰</li>
<li class="">å›æ‡‰ clientï¼ˆä¸å¿…ç­‰è³‡æ–™åˆä½µï¼‰</li>
<li class="">èƒŒæ™¯ worker å®šæœŸå°‡ queue äº‹ä»¶ <strong>merge æˆ Parquet</strong></li>
<li class="">æ¸…é™¤å·²è™•ç†äº‹ä»¶</li>
</ol>
<p>ç­‰åŒ event sourcing + compactionï¼š</p>
<blockquote>
<p>å–®å¯«ã€å¤šè®€ã€é«˜ç©©å®šæ€§çš„ event-based architecture</p>
</blockquote>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="6-å´©æ½°å¾©åŸç­–ç•¥">6. å´©æ½°å¾©åŸç­–ç•¥<a href="#6-å´©æ½°å¾©åŸç­–ç•¥" class="hash-link" aria-label="Direct link to 6. å´©æ½°å¾©åŸç­–ç•¥" title="Direct link to 6. å´©æ½°å¾©åŸç­–ç•¥" translate="no">â€‹</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="writer-å´©æ½°">Writer å´©æ½°<a href="#writer-å´©æ½°" class="hash-link" aria-label="Direct link to Writer å´©æ½°" title="Direct link to Writer å´©æ½°" translate="no">â€‹</a></h3>
<ul>
<li class="">queueï¼ˆSQLite/LMDBï¼‰æ˜¯ ACID</li>
<li class="">é‡å•Ÿä¹‹å¾Œ worker è®€ queue è£¡å°šæœª processed çš„äº‹ä»¶é‡æ–°è·‘</li>
<li class="">ä¸æœƒéºå¤±è³‡æ–™</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="worker-å´©æ½°">Worker å´©æ½°<a href="#worker-å´©æ½°" class="hash-link" aria-label="Direct link to Worker å´©æ½°" title="Direct link to Worker å´©æ½°" translate="no">â€‹</a></h3>
<ul>
<li class="">ä¸å½±éŸ¿ writer</li>
<li class="">compaction æ²’è·‘å®Œä¸‹æ¬¡é‡å•Ÿå†è·‘</li>
<li class="">snapshotï¼ˆParquet/SQLiteï¼‰ä»æœ‰æ•ˆ</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="snapshot--nfs-å‚™æ´">Snapshot / NFS å‚™æ´<a href="#snapshot--nfs-å‚™æ´" class="hash-link" aria-label="Direct link to Snapshot / NFS å‚™æ´" title="Direct link to Snapshot / NFS å‚™æ´" translate="no">â€‹</a></h3>
<ul>
<li class="">å®šæ™‚ copy parquet åˆ° NFS</li>
<li class="">API æ›æ‰ â†’ å®¢æˆ¶ç«¯ switch åˆ° <strong>ç›´æ¥è®€ NFS</strong></li>
<li class="">parquet æ”¯æŒ predicate pushdown â†’ ä¸éœ€è®€æ•´æª”</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="7-å®¢æˆ¶ç«¯å¯å¦ç›´æ¥è®€æª”">7. å®¢æˆ¶ç«¯å¯å¦ç›´æ¥è®€æª”ï¼Ÿ<a href="#7-å®¢æˆ¶ç«¯å¯å¦ç›´æ¥è®€æª”" class="hash-link" aria-label="Direct link to 7. å®¢æˆ¶ç«¯å¯å¦ç›´æ¥è®€æª”ï¼Ÿ" title="Direct link to 7. å®¢æˆ¶ç«¯å¯å¦ç›´æ¥è®€æª”ï¼Ÿ" translate="no">â€‹</a></h2>
<p>æ˜¯çš„ï¼Œå®Œå…¨å¯è¡Œï¼Œä¸¦é©åˆè®€å¤šå¯«å°‘æ¶æ§‹ã€‚</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="duckdb-client-read-ç¤ºä¾‹">DuckDB client read ç¤ºä¾‹<a href="#duckdb-client-read-ç¤ºä¾‹" class="hash-link" aria-label="Direct link to DuckDB client read ç¤ºä¾‹" title="Direct link to DuckDB client read ç¤ºä¾‹" translate="no">â€‹</a></h3>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> duckdb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">con </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> duckdb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">df </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> con</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    SELECT * </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    FROM &#x27;nfs/projects/*.parquet&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    WHERE project_id = 123</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>ç‰¹é»ï¼š</p>
<ul>
<li class="">ä¸éœ€è¼‰å…¥æ•´æª”</li>
<li class="">column pruning / row filtering</li>
<li class="">é©åˆå…§ç¶²ç’°å¢ƒ</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="8-writerfastapiç¯„ä¾‹">8. Writerï¼ˆFastAPIï¼‰ç¯„ä¾‹<a href="#8-writerfastapiç¯„ä¾‹" class="hash-link" aria-label="Direct link to 8. Writerï¼ˆFastAPIï¼‰ç¯„ä¾‹" title="Direct link to 8. Writerï¼ˆFastAPIï¼‰ç¯„ä¾‹" translate="no">â€‹</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="sqlite-queue-schema">SQLite queue schema<a href="#sqlite-queue-schema" class="hash-link" aria-label="Direct link to SQLite queue schema" title="Direct link to SQLite queue schema" translate="no">â€‹</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> queue </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id </span><span class="token keyword" style="color:#00009f">INTEGER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> AUTOINCREMENT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    event JSON</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ts </span><span class="token keyword" style="color:#00009f">TIMESTAMP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">CURRENT_TIMESTAMP</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    processed </span><span class="token keyword" style="color:#00009f">INTEGER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="fastapi-append-event">FastAPI append event<a href="#fastapi-append-event" class="hash-link" aria-label="Direct link to FastAPI append event" title="Direct link to FastAPI append event" translate="no">â€‹</a></h3>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> fastapi </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> FastAPI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> sqlite3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> FastAPI</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">conn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sqlite3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;queue.db&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> check_same_thread</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@app</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">post</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/write&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">write_event</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">dict</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;INSERT INTO queue (event) VALUES (?)&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dumps</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">commit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;status&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ok&quot;</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="9-èƒŒæ™¯-workeråˆä½µåˆ°-parquet">9. èƒŒæ™¯ Workerï¼ˆåˆä½µåˆ° Parquetï¼‰<a href="#9-èƒŒæ™¯-workeråˆä½µåˆ°-parquet" class="hash-link" aria-label="Direct link to 9. èƒŒæ™¯ Workerï¼ˆåˆä½µåˆ° Parquetï¼‰" title="Direct link to 9. èƒŒæ™¯ Workerï¼ˆåˆä½µåˆ° Parquetï¼‰" translate="no">â€‹</a></h2>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> sqlite3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> duckdb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pyarrow </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> pyarrow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">parquet </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> pq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">process_queue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sqlite3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;queue.db&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cur </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;SELECT id, event FROM queue WHERE processed = 0&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rows </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> r</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">**</span><span class="token plain">json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loads</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> r </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> cur</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fetchall</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> rows</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># è½‰æˆ Parquet</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    table </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Table</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_pylist</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rows</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write_table</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;data/day_2025_02_17.parquet&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> append</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ids </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;id&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> r </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> rows</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;UPDATE queue SET processed=1 WHERE id IN (</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation string" style="color:#e3116c">&#x27;,&#x27;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">join</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation builtin">map</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation builtin">str</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">,</span><span class="token string-interpolation interpolation"> ids</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">)&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">commit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="10-lmdb-ä½œç‚º-queue-çš„ç¯„ä¾‹">10. LMDB ä½œç‚º Queue çš„ç¯„ä¾‹<a href="#10-lmdb-ä½œç‚º-queue-çš„ç¯„ä¾‹" class="hash-link" aria-label="Direct link to 10. LMDB ä½œç‚º Queue çš„ç¯„ä¾‹" title="Direct link to 10. LMDB ä½œç‚º Queue çš„ç¯„ä¾‹" translate="no">â€‹</a></h2>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> lmdb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> json</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">env </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lmdb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;queue.lmdb&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> map_size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1e9</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">enqueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">begin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">write</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> txn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">time_ns</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        txn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dumps</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>ç‰¹æ€§ï¼š</p>
<ul>
<li class="">å–® writerã€å¤š reader</li>
<li class="">crash-safe</li>
<li class="">æ•ˆèƒ½æ¥µé«˜</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="11-æœ€çµ‚é¸æ“‡">11. æœ€çµ‚é¸æ“‡<a href="#11-æœ€çµ‚é¸æ“‡" class="hash-link" aria-label="Direct link to 11. æœ€çµ‚é¸æ“‡" title="Direct link to 11. æœ€çµ‚é¸æ“‡" translate="no">â€‹</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="æœ€ä½ç¶­é‹æœ€é«˜å¯é è®€å¯«æ¨¡å¼æœ€é©é…">æœ€ä½ç¶­é‹ã€æœ€é«˜å¯é ã€è®€å¯«æ¨¡å¼æœ€é©é…ï¼š<a href="#æœ€ä½ç¶­é‹æœ€é«˜å¯é è®€å¯«æ¨¡å¼æœ€é©é…" class="hash-link" aria-label="Direct link to æœ€ä½ç¶­é‹ã€æœ€é«˜å¯é ã€è®€å¯«æ¨¡å¼æœ€é©é…ï¼š" title="Direct link to æœ€ä½ç¶­é‹ã€æœ€é«˜å¯é ã€è®€å¯«æ¨¡å¼æœ€é©é…ï¼š" translate="no">â€‹</a></h3>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="writer">Writer<a href="#writer" class="hash-link" aria-label="Direct link to Writer" title="Direct link to Writer" translate="no">â€‹</a></h3>
<ul>
<li class="">FastAPIï¼ˆæˆ– flaskï¼‰</li>
<li class="">å–®ä¸€ writer process â†’ è¿½åŠ äº‹ä»¶åˆ° Queue</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="queue">Queue<a href="#queue" class="hash-link" aria-label="Direct link to Queue" title="Direct link to Queue" translate="no">â€‹</a></h3>
<ul>
<li class="">SQLiteï¼ˆæ¥µç°¡ï¼‰</li>
<li class="">è‹¥è¿½æ±‚æ•ˆèƒ½å†ç”¨ LMDB</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="background-worker">Background Worker<a href="#background-worker" class="hash-link" aria-label="Direct link to Background Worker" title="Direct link to Background Worker" translate="no">â€‹</a></h3>
<ul>
<li class="">å®šæœŸå°‡ queue â†’ Parquet</li>
<li class="">åˆ†æ—¥æœŸ/å°ˆæ¡ˆç”¢æª”</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="reader">Reader<a href="#reader" class="hash-link" aria-label="Direct link to Reader" title="Direct link to Reader" translate="no">â€‹</a></h3>
<ul>
<li class="">å®¢æˆ¶ç«¯å¯ä»¥ç›´æ¥è®€ parquet + DuckDB</li>
<li class="">æˆ–ç¶“ API æŸ¥è©¢</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="failover">Failover<a href="#failover" class="hash-link" aria-label="Direct link to Failover" title="Direct link to Failover" translate="no">â€‹</a></h3>
<ul>
<li class="">queue ACID ä¿è­‰ä¸éºå¤±</li>
<li class="">parquet snapshot æ”¾ NFS</li>
<li class="">API æ›æ‰è®€ snapshot ä»å¯é‹ä½œ</li>
</ul>
<hr></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" title="Python programming language" class="tag_zVej tagRegular_sFm0" href="/blog/tags/python">Python</a></li><li class="tag_QGVx"><a rel="tag" title="Shotgun/Shotgrid/FlowProductionTracking" class="tag_zVej tagRegular_sFm0" href="/blog/tags/sg-fpt">Shotgun/Shotgrid/FlowProductionTracking</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"></nav></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://x.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/chinishou" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.flaticon.com/free-icons/keyboard-key" target="_blank" rel="noopener noreferrer" class="footer__link-item">Keyboard key icons(Logo) created by littleicon - Flaticon<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2025 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>