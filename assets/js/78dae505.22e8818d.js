"use strict";(globalThis.webpackChunkmy_docusaurus=globalThis.webpackChunkmy_docusaurus||[]).push([[5380],{345:e=>{e.exports=JSON.parse('{"permalink":"/blog/first-blog-post","source":"@site/blog/2025-11-16-SG-FPT-cache-system.md","title":"First Blog Post","description":"\uff08Python\u3001FastAPI \u5167\u7db2\u74b0\u5883\u3001SQLite / DuckDB / Parquet\uff09","date":"2025-11-16T00:00:00.000Z","tags":[{"inline":false,"label":"Python","permalink":"/blog/tags/python","description":"Python programming language"},{"inline":false,"label":"Shotgun/Shotgrid/FlowProductionTracking","permalink":"/blog/tags/sg-fpt","description":"Shotgun/Shotgrid/FlowProductionTracking"}],"readingTime":3.94,"hasTruncateMarker":false,"authors":[{"name":"Wei Hsiang Chen","title":"Pipeline TD","url":"https://www.linkedin.com/in/weihsiangchen-fx","page":{"permalink":"/blog/authors/weihsiangchen"},"socials":{"x":"https://x.com/wei_Ch_","linkedin":"https://www.linkedin.com/in/weihsiangchen-fx/","github":"https://github.com/chinishou","newsletter":"https://chinishou.github.io/"},"imageURL":"https://www.linkedin.com/in/weihsiangchen-fx","key":"weihsiangchen"}],"frontMatter":{"slug":"first-blog-post","title":"First Blog Post","authors":["weihsiangchen"],"tags":["python","SG/FPT"]},"unlisted":false,"nextItem":{"title":"Welcome","permalink":"/blog/welcome"}}')},4879:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>d,default:()=>o,frontMatter:()=>t,metadata:()=>i,toc:()=>h});var i=r(345),l=r(4848),s=r(8453);const t={slug:"first-blog-post",title:"First Blog Post",authors:["weihsiangchen"],tags:["python","SG/FPT"]},d="\u5c08\u6848\u8ffd\u8e64\u8cc7\u6599\u5feb\u53d6\u7cfb\u7d71\uff1a\u55ae\u4e00 Writer\u3001\u591a Reader \u7684\u8cc7\u6599\u67b6\u69cb\u8a2d\u8a08\u7d00\u9304",c={authorsImageUrls:[void 0]},h=[{value:"1. \u554f\u984c\u80cc\u666f",id:"1-\u554f\u984c\u80cc\u666f",level:2},{value:"2. \u67b6\u69cb\u7e3d\u89bd",id:"2-\u67b6\u69cb\u7e3d\u89bd",level:2},{value:"\ud83c\udfd7\ufe0f Mermaid \u67b6\u69cb\u5716",id:"\ufe0f-mermaid-\u67b6\u69cb\u5716",level:2},{value:"3. \u6a94\u6848\u5206\u5272\u7b56\u7565",id:"3-\u6a94\u6848\u5206\u5272\u7b56\u7565",level:2},{value:"4. \u591a\u8b80\u55ae\u5beb\u7b56\u7565\uff1a\u53ef\u80fd\u7684\u8cc7\u6599\u683c\u5f0f",id:"4-\u591a\u8b80\u55ae\u5beb\u7b56\u7565\u53ef\u80fd\u7684\u8cc7\u6599\u683c\u5f0f",level:2},{value:"5. \u80cc\u666f Queue / WAL \u8a2d\u8a08",id:"5-\u80cc\u666f-queue--wal-\u8a2d\u8a08",level:2},{value:"6. \u5d29\u6f70\u5fa9\u539f\u7b56\u7565",id:"6-\u5d29\u6f70\u5fa9\u539f\u7b56\u7565",level:2},{value:"Writer \u5d29\u6f70",id:"writer-\u5d29\u6f70",level:3},{value:"Worker \u5d29\u6f70",id:"worker-\u5d29\u6f70",level:3},{value:"Snapshot / NFS \u5099\u63f4",id:"snapshot--nfs-\u5099\u63f4",level:3},{value:"7. \u5ba2\u6236\u7aef\u53ef\u5426\u76f4\u63a5\u8b80\u6a94\uff1f",id:"7-\u5ba2\u6236\u7aef\u53ef\u5426\u76f4\u63a5\u8b80\u6a94",level:2},{value:"DuckDB client read \u793a\u4f8b",id:"duckdb-client-read-\u793a\u4f8b",level:3},{value:"8. Writer\uff08FastAPI\uff09\u7bc4\u4f8b",id:"8-writerfastapi\u7bc4\u4f8b",level:2},{value:"SQLite queue schema",id:"sqlite-queue-schema",level:3},{value:"FastAPI append event",id:"fastapi-append-event",level:3},{value:"9. \u80cc\u666f Worker\uff08\u5408\u4f75\u5230 Parquet\uff09",id:"9-\u80cc\u666f-worker\u5408\u4f75\u5230-parquet",level:2},{value:"10. LMDB \u4f5c\u70ba Queue \u7684\u7bc4\u4f8b",id:"10-lmdb-\u4f5c\u70ba-queue-\u7684\u7bc4\u4f8b",level:2},{value:"11. \u6700\u7d42\u9078\u64c7",id:"11-\u6700\u7d42\u9078\u64c7",level:2},{value:"\u6700\u4f4e\u7dad\u904b\u3001\u6700\u9ad8\u53ef\u9760\u3001\u8b80\u5beb\u6a21\u5f0f\u6700\u9069\u914d\uff1a",id:"\u6700\u4f4e\u7dad\u904b\u6700\u9ad8\u53ef\u9760\u8b80\u5beb\u6a21\u5f0f\u6700\u9069\u914d",level:3},{value:"Writer",id:"writer",level:3},{value:"Queue",id:"queue",level:3},{value:"Background Worker",id:"background-worker",level:3},{value:"Reader",id:"reader",level:3},{value:"Failover",id:"failover",level:3}];function a(e){const n={blockquote:"blockquote",br:"br",code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.p,{children:"\uff08Python\u3001FastAPI \u5167\u7db2\u74b0\u5883\u3001SQLite / DuckDB / Parquet\uff09"}),"\n",(0,l.jsx)(n.h2,{id:"1-\u554f\u984c\u80cc\u666f",children:"1. \u554f\u984c\u80cc\u666f"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u7522\u696d\uff1a\u5f71\u8996"}),"\n",(0,l.jsx)(n.li,{children:"\u76ee\u7684\u662f\u6e1b\u5c11\u8a2a\u554fSG/FPT\u7684\u6b21\u6578\uff0c\u800c\u975e\u8ffd\u6c42\u901f\u5ea6"}),"\n",(0,l.jsx)(n.li,{children:"column\u901a\u5e38\u4e0d\u8d85\u904e50"}),"\n",(0,l.jsxs)(n.li,{children:["\u5beb\u5165\u983b\u7387\uff1a200 \u4eba \xd7 \u6bcf\u5929\u7d04 100 \u7b46 \u2192 ",(0,l.jsx)(n.strong,{children:"20,000 writes / day"})]}),"\n",(0,l.jsxs)(n.li,{children:["\u8b80\u53d6\u5247\u9810\u4f30\u7d04\u5beb\u5165\u7684 10 \u500d \u2192 ",(0,l.jsx)(n.strong,{children:"200,000 reads / day"})]}),"\n",(0,l.jsxs)(n.li,{children:["\u4f7f\u7528\u60c5\u5883\uff1a","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5c08\u6848\u7d50\u675f\u5f8c\u53ef\u4e1f\u68c4\u6216\u55ae\u7368\u5099\u4efd"}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.strong,{children:"\u5beb\u5c11\u8b80\u591a"})}),"\n",(0,l.jsx)(n.li,{children:"\u60f3\u8981\u6700\u4f4e\u7dad\u8b77\u6210\u672c\uff08\u4eba\u529b\u3001\u786c\u9ad4\u3001\u77e5\u8b58\u8ca0\u64d4\uff09"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u76ee\u6a19\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u80fdRelational searching"}),"\n",(0,l.jsx)(n.li,{children:"Embedded DB"}),"\n",(0,l.jsx)(n.li,{children:"\u53ef\u4f9d\u65e5\u671f / \u5c08\u6848\u6b78\u6a94"}),"\n",(0,l.jsx)(n.li,{children:"\u55ae\u4e00writer\u8207\u591areader\u4e26\u884c"}),"\n",(0,l.jsx)(n.li,{children:"\u5d29\u6f70\u5f8c\u80fd\u5feb\u901f\u5fa9\u539f\uff0c\u5fa9\u539f\u5f8c\u81ea\u52d5\u91cd\u8a66\u4efb\u52d9\u968a\u5217"}),"\n",(0,l.jsx)(n.li,{children:"\u5728NFS\u4e0a\u5b58\u653e\u5feb\u7167\uff0c\u7cfb\u7d71\u5d29\u6f70\u6642\u8b80\u53d6\u5176\u4f5c\u70ba\u61c9\u6025\u65b9\u6848"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"2-\u67b6\u69cb\u7e3d\u89bd",children:"2. \u67b6\u69cb\u7e3d\u89bd"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Writer \u63a1\u300c\u4e8b\u4ef6 append-only\u300d\u5beb\u5165\uff08\u5982 WAL/queue\uff09"}),"\n",(0,l.jsx)(n.li,{children:"\u5f8c\u7aef\u8ca0\u8cac\u5408\u4f75\u8cc7\u6599\u8207\u7522\u751f\u65e5\u6a94/parquet/db"}),"\n",(0,l.jsxs)(n.li,{children:["Reader \u8b80\u7684\u662f ",(0,l.jsx)(n.strong,{children:"\u5df2\u5c01\u5b58\u7684\u7a69\u5b9a\u6a94\u6848"}),"\uff08immutable file\uff09"]}),"\n",(0,l.jsx)(n.li,{children:"Writer \u7576\u6389\u6642\u53ef\u91cd\u8dd1 queue\uff0c\u6216\u8b80 snapshot \u7e7c\u7e8c\u5beb"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"\ufe0f-mermaid-\u67b6\u69cb\u5716",children:"\ud83c\udfd7\ufe0f Mermaid \u67b6\u69cb\u5716"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-mermaid",children:'flowchart LR\n\nsubgraph Clients\n    A[\u4f7f\u7528\u8005 / \u5ba2\u6236\u7aef]\nend\n\nA --\x3e|Write| W["Writer<br>(FastAPI)"]\nW --\x3e|Append event| Q["Queue DB<br>(SQLite/LMDB)"]\nW --\x3e|Read| S["(Snapshots<br>Parquet/SQLite)"]\n\nsubgraph Background Workers\n    M[Merger / Compaction Worker]\nend\n\nQ --\x3e|Batch Process| M\nM --\x3e|Write Partition Files| S\nA --\x3e|Direct Read| S\n'})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"3-\u6a94\u6848\u5206\u5272\u7b56\u7565",children:"3. \u6a94\u6848\u5206\u5272\u7b56\u7565"}),"\n",(0,l.jsxs)(n.p,{children:["\u2714 \u53ef\u505a ",(0,l.jsx)(n.strong,{children:"\u6309\u65e5\u671f"})," \u6216 ",(0,l.jsx)(n.strong,{children:"\u6309\u5c08\u6848"})," \u5206\u6a94",(0,l.jsx)(n.br,{}),"\n","\u2714 Writer \u53ea\u5beb\u300c\u7576\u5929\u300d\u6216\u300c\u7576\u524d\u5c08\u6848\u300d",(0,l.jsx)(n.br,{}),"\n","\u2714 Reader \u53ef\u8b80\u6240\u6709\u6a94\u6848\uff08\u901a\u5e38\u662f\u53ea\u8b80\u4e14\u4e26\u884c\u5ea6\u9ad8\uff09"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"4-\u591a\u8b80\u55ae\u5beb\u7b56\u7565\u53ef\u80fd\u7684\u8cc7\u6599\u683c\u5f0f",children:"4. \u591a\u8b80\u55ae\u5beb\u7b56\u7565\uff1a\u53ef\u80fd\u7684\u8cc7\u6599\u683c\u5f0f"}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"\u6280\u8853"}),(0,l.jsx)(n.th,{children:"\u512a\u9ede"}),(0,l.jsx)(n.th,{children:"\u7f3a\u9ede"}),(0,l.jsx)(n.th,{children:"\u9069\u5408\u7528\u9014"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"SQLite"})}),(0,l.jsx)(n.td,{children:"\u55ae\u5beb\u591a\u8b80\u3001\u6210\u719f\u3001\u7c21\u55ae"}),(0,l.jsx)(n.td,{children:"\u5beb\u5165\u963b\u585e\uff08\u4f46\u91cf\u4e0d\u5927\u53ef\u63a5\u53d7\uff09"}),(0,l.jsx)(n.td,{children:"\u65e5\u6a94 or \u5c0f\u578b transactional"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"DuckDB + Parquet"})}),(0,l.jsx)(n.td,{children:"\u8d85\u5feb\u67e5\u8a62\u3001\u514d\u8f09\u6574\u6a94"}),(0,l.jsx)(n.td,{children:"\u4e0d\u9069\u5408\u591a writer\uff08\u4f46\u4f60\u7528\u55ae writer \u5373\u53ef\uff09"}),(0,l.jsx)(n.td,{children:"\u5206\u6790\u67e5\u8a62\u3001\u591a reader"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"LMDB"})}),(0,l.jsx)(n.td,{children:"\u8d85\u5feb\u8b80\u3001\u591a reader\u3001\u55ae writer"}),(0,l.jsx)(n.td,{children:"\u56b4\u683c\u55ae writer\uff0c\u5beb\u5165\u53ef\u80fd block"}),(0,l.jsx)(n.td,{children:"queue\u3001metadata"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"Redis (AOF)"})}),(0,l.jsx)(n.td,{children:"\u505a queue \u6d41\u7a0b\u5f88\u5f37"}),(0,l.jsx)(n.td,{children:"\u591a\u4e00\u9053\u7dad\u904b"}),(0,l.jsx)(n.td,{children:"\u82e5\u8981\u66f4\u5f48\u6027 event queue"})]})]})]}),"\n",(0,l.jsx)(n.p,{children:"\u5019\u9078\u65b9\u6848\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.strong,{children:"Parquet + DuckDB"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.strong,{children:"SQLite"})}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u843d\u9078\u65b9\u6848:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Redis: \u7121\u6cd5SQL"}),"\n",(0,l.jsx)(n.li,{children:"Postgres: \u4e0d\u5fc5\u8981\u7684\u7dad\u8b77\u6210\u672c"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"5-\u80cc\u666f-queue--wal-\u8a2d\u8a08",children:"5. \u80cc\u666f Queue / WAL \u8a2d\u8a08"}),"\n",(0,l.jsx)(n.p,{children:"Writer \u6536\u5230\u8cc7\u6599\u5f8c\uff1a"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:"append event \u2192 queue\uff08\u4f8b\u5982 SQLite / LMDB\uff09"}),"\n",(0,l.jsx)(n.li,{children:"\u56de\u61c9 client\uff08\u4e0d\u5fc5\u7b49\u8cc7\u6599\u5408\u4f75\uff09"}),"\n",(0,l.jsxs)(n.li,{children:["\u80cc\u666f worker \u5b9a\u671f\u5c07 queue \u4e8b\u4ef6 ",(0,l.jsx)(n.strong,{children:"merge \u6210 Parquet"})]}),"\n",(0,l.jsx)(n.li,{children:"\u6e05\u9664\u5df2\u8655\u7406\u4e8b\u4ef6"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"\u7b49\u540c event sourcing + compaction\uff1a"}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:"\u55ae\u5beb\u3001\u591a\u8b80\u3001\u9ad8\u7a69\u5b9a\u6027\u7684 event-based architecture"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"6-\u5d29\u6f70\u5fa9\u539f\u7b56\u7565",children:"6. \u5d29\u6f70\u5fa9\u539f\u7b56\u7565"}),"\n",(0,l.jsx)(n.h3,{id:"writer-\u5d29\u6f70",children:"Writer \u5d29\u6f70"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"queue\uff08SQLite/LMDB\uff09\u662f ACID"}),"\n",(0,l.jsx)(n.li,{children:"\u91cd\u555f\u4e4b\u5f8c worker \u8b80 queue \u88e1\u5c1a\u672a processed \u7684\u4e8b\u4ef6\u91cd\u65b0\u8dd1"}),"\n",(0,l.jsx)(n.li,{children:"\u4e0d\u6703\u907a\u5931\u8cc7\u6599"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"worker-\u5d29\u6f70",children:"Worker \u5d29\u6f70"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u4e0d\u5f71\u97ff writer"}),"\n",(0,l.jsx)(n.li,{children:"compaction \u6c92\u8dd1\u5b8c\u4e0b\u6b21\u91cd\u555f\u518d\u8dd1"}),"\n",(0,l.jsx)(n.li,{children:"snapshot\uff08Parquet/SQLite\uff09\u4ecd\u6709\u6548"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"snapshot--nfs-\u5099\u63f4",children:"Snapshot / NFS \u5099\u63f4"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5b9a\u6642 copy parquet \u5230 NFS"}),"\n",(0,l.jsxs)(n.li,{children:["API \u639b\u6389 \u2192 \u5ba2\u6236\u7aef switch \u5230 ",(0,l.jsx)(n.strong,{children:"\u76f4\u63a5\u8b80 NFS"})]}),"\n",(0,l.jsx)(n.li,{children:"parquet \u652f\u6301 predicate pushdown \u2192 \u4e0d\u9700\u8b80\u6574\u6a94"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"7-\u5ba2\u6236\u7aef\u53ef\u5426\u76f4\u63a5\u8b80\u6a94",children:"7. \u5ba2\u6236\u7aef\u53ef\u5426\u76f4\u63a5\u8b80\u6a94\uff1f"}),"\n",(0,l.jsx)(n.p,{children:"\u662f\u7684\uff0c\u5b8c\u5168\u53ef\u884c\uff0c\u4e26\u9069\u5408\u8b80\u591a\u5beb\u5c11\u67b6\u69cb\u3002"}),"\n",(0,l.jsx)(n.h3,{id:"duckdb-client-read-\u793a\u4f8b",children:"DuckDB client read \u793a\u4f8b"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:'import duckdb\n\ncon = duckdb.connect()\ndf = con.execute("""\n    SELECT * \n    FROM \'nfs/projects/*.parquet\'\n    WHERE project_id = 123\n""").df()\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u7279\u9ede\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u4e0d\u9700\u8f09\u5165\u6574\u6a94"}),"\n",(0,l.jsx)(n.li,{children:"column pruning / row filtering"}),"\n",(0,l.jsx)(n.li,{children:"\u9069\u5408\u5167\u7db2\u74b0\u5883"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"8-writerfastapi\u7bc4\u4f8b",children:"8. Writer\uff08FastAPI\uff09\u7bc4\u4f8b"}),"\n",(0,l.jsx)(n.h3,{id:"sqlite-queue-schema",children:"SQLite queue schema"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE queue (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    event JSON,\n    ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    processed INTEGER DEFAULT 0\n);\n"})}),"\n",(0,l.jsx)(n.h3,{id:"fastapi-append-event",children:"FastAPI append event"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:'from fastapi import FastAPI\nimport sqlite3, json\n\napp = FastAPI()\nconn = sqlite3.connect("queue.db", check_same_thread=False)\n\n@app.post("/write")\ndef write_event(event: dict):\n    conn.execute("INSERT INTO queue (event) VALUES (?)", \n                 [json.dumps(event)])\n    conn.commit()\n    return {"status": "ok"}\n'})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"9-\u80cc\u666f-worker\u5408\u4f75\u5230-parquet",children:"9. \u80cc\u666f Worker\uff08\u5408\u4f75\u5230 Parquet\uff09"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:'import sqlite3, duckdb, json\nfrom pyarrow import Table\nimport pyarrow.parquet as pq\n\ndef process_queue():\n    conn = sqlite3.connect("queue.db")\n    cur = conn.execute("SELECT id, event FROM queue WHERE processed = 0")\n\n    rows = [{"id": r[0], **json.loads(r[1])} for r in cur.fetchall()]\n    if not rows:\n        return\n\n    # \u8f49\u6210 Parquet\n    table = Table.from_pylist(rows)\n    pq.write_table(table, "data/day_2025_02_17.parquet", append=True)\n\n    ids = [r["id"] for r in rows]\n    conn.execute(\n        f"UPDATE queue SET processed=1 WHERE id IN ({\',\'.join(map(str, ids))})"\n    )\n    conn.commit()\n'})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"10-lmdb-\u4f5c\u70ba-queue-\u7684\u7bc4\u4f8b",children:"10. LMDB \u4f5c\u70ba Queue \u7684\u7bc4\u4f8b"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:'import lmdb, json, time\n\nenv = lmdb.open("queue.lmdb", map_size=1e9)\n\ndef enqueue(event):\n    with env.begin(write=True) as txn:\n        key = str(time.time_ns()).encode()\n        txn.put(key, json.dumps(event).encode())\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u7279\u6027\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u55ae writer\u3001\u591a reader"}),"\n",(0,l.jsx)(n.li,{children:"crash-safe"}),"\n",(0,l.jsx)(n.li,{children:"\u6548\u80fd\u6975\u9ad8"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"11-\u6700\u7d42\u9078\u64c7",children:"11. \u6700\u7d42\u9078\u64c7"}),"\n",(0,l.jsx)(n.h3,{id:"\u6700\u4f4e\u7dad\u904b\u6700\u9ad8\u53ef\u9760\u8b80\u5beb\u6a21\u5f0f\u6700\u9069\u914d",children:"\u6700\u4f4e\u7dad\u904b\u3001\u6700\u9ad8\u53ef\u9760\u3001\u8b80\u5beb\u6a21\u5f0f\u6700\u9069\u914d\uff1a"}),"\n",(0,l.jsx)(n.h3,{id:"writer",children:"Writer"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"FastAPI\uff08\u6216 flask\uff09"}),"\n",(0,l.jsx)(n.li,{children:"\u55ae\u4e00 writer process \u2192 \u8ffd\u52a0\u4e8b\u4ef6\u5230 Queue"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"queue",children:"Queue"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"SQLite\uff08\u6975\u7c21\uff09"}),"\n",(0,l.jsx)(n.li,{children:"\u82e5\u8ffd\u6c42\u6548\u80fd\u518d\u7528 LMDB"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"background-worker",children:"Background Worker"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5b9a\u671f\u5c07 queue \u2192 Parquet"}),"\n",(0,l.jsx)(n.li,{children:"\u5206\u65e5\u671f/\u5c08\u6848\u7522\u6a94"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"reader",children:"Reader"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u5ba2\u6236\u7aef\u53ef\u4ee5\u76f4\u63a5\u8b80 parquet + DuckDB"}),"\n",(0,l.jsx)(n.li,{children:"\u6216\u7d93 API \u67e5\u8a62"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"failover",children:"Failover"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"queue ACID \u4fdd\u8b49\u4e0d\u907a\u5931"}),"\n",(0,l.jsx)(n.li,{children:"parquet snapshot \u653e NFS"}),"\n",(0,l.jsx)(n.li,{children:"API \u639b\u6389\u8b80 snapshot \u4ecd\u53ef\u904b\u4f5c"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{})]})}function o(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(a,{...e})}):a(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>t,x:()=>d});var i=r(6540);const l={},s=i.createContext(l);function t(e){const n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:t(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);